
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Static site hosting documentation for customer churn prediction curated by Utku Can Ozturk.">
      
      
      
        <meta name="author" content="Utku Can Ozturk">
      
      
        <link rel="canonical" href="https://utkucanozturk.github.io/customer-churn-prediction/model/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>Modeling - Customer Churn Prediction</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#modeling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Customer Churn Prediction" class="md-header__button md-logo" aria-label="Customer Churn Prediction" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 17v2h-8v-2h8m-2-6V8H4v3h16m-7 2v1.68c-.63.95-1 2.09-1 3.32 0 1.09.29 2.12.8 3H4a2 2 0 0 1-2-2V3l1.67 1.67L5.33 3 7 4.67 8.67 3l1.66 1.67L12 3l1.67 1.67L15.33 3 17 4.67 18.67 3l1.66 1.67L22 3v10.5a6.137 6.137 0 0 0-4-1.5c-1.23 0-2.37.37-3.32 1H13m-2 6v-6H4v6h7z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Customer Churn Prediction
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Modeling
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../data/" class="md-tabs__link">
      Dataset
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      Modeling
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../extra/" class="md-tabs__link">
      Extras
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Customer Churn Prediction" class="md-nav__button md-logo" aria-label="Customer Churn Prediction" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 17v2h-8v-2h8m-2-6V8H4v3h16m-7 2v1.68c-.63.95-1 2.09-1 3.32 0 1.09.29 2.12.8 3H4a2 2 0 0 1-2-2V3l1.67 1.67L5.33 3 7 4.67 8.67 3l1.66 1.67L12 3l1.67 1.67L15.33 3 17 4.67 18.67 3l1.66 1.67L22 3v10.5a6.137 6.137 0 0 0-4-1.5c-1.23 0-2.37.37-3.32 1H13m-2 6v-6H4v6h7z"/></svg>

    </a>
    Customer Churn Prediction
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Dataset
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Modeling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Modeling
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#evaluation-metric" class="md-nav__link">
    Evaluation Metric
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#algorithms" class="md-nav__link">
    Algorithms
  </a>
  
    <nav class="md-nav" aria-label="Algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ligth-gradient-boosting-machine-lightgbm" class="md-nav__link">
    Ligth Gradient Boosting Machine (LightGBM)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extreme-gradient-boosting-xgboost" class="md-nav__link">
    Extreme Gradient Boosting (XGBoost)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#support-vector-machines-svm" class="md-nav__link">
    Support Vector Machines (SVM)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-evaluation" class="md-nav__link">
    Model Evaluation
  </a>
  
    <nav class="md-nav" aria-label="Model Evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-importances" class="md-nav__link">
    Feature Importances
  </a>
  
    <nav class="md-nav" aria-label="Feature Importances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permutation-feature-importance" class="md-nav__link">
    Permutation Feature Importance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shapley-feature-importance" class="md-nav__link">
    Shapley Feature Importance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#statistical-models" class="md-nav__link">
    Statistical Models
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../extra/" class="md-nav__link">
        Extras
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#evaluation-metric" class="md-nav__link">
    Evaluation Metric
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#algorithms" class="md-nav__link">
    Algorithms
  </a>
  
    <nav class="md-nav" aria-label="Algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ligth-gradient-boosting-machine-lightgbm" class="md-nav__link">
    Ligth Gradient Boosting Machine (LightGBM)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extreme-gradient-boosting-xgboost" class="md-nav__link">
    Extreme Gradient Boosting (XGBoost)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#support-vector-machines-svm" class="md-nav__link">
    Support Vector Machines (SVM)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-evaluation" class="md-nav__link">
    Model Evaluation
  </a>
  
    <nav class="md-nav" aria-label="Model Evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-importances" class="md-nav__link">
    Feature Importances
  </a>
  
    <nav class="md-nav" aria-label="Feature Importances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permutation-feature-importance" class="md-nav__link">
    Permutation Feature Importance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shapley-feature-importance" class="md-nav__link">
    Shapley Feature Importance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#statistical-models" class="md-nav__link">
    Statistical Models
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="modeling">Modeling<a class="headerlink" href="#modeling" title="Permanent link">&para;</a></h1>
<p>Since it is unknown what are the measures for the user retention, various machine learning algorithms are compared in terms of their ability to distinguish user retention score. To be able to assess the quality of each model a 3-fold cross-validation procedure is performed. Finally the evaluation of promising algorithms will be done in <a href="eval.md">Model Evaluation</a>.</p>
<h2 id="evaluation-metric">Evaluation Metric<a class="headerlink" href="#evaluation-metric" title="Permanent link">&para;</a></h2>
<p>Probably the most straight forward metric to evaluate regression tasks is root mean squared error (RMSE) and in this regression analysis we will use RMSE as our evaluation metric. RMSE is the square root of the average of squared errors. The RMSE serves to aggregate the magnitudes of the errors in predictions for various data points into a single measure of predictive power.</p>
<h2 id="algorithms">Algorithms<a class="headerlink" href="#algorithms" title="Permanent link">&para;</a></h2>
<p>We will use two gradient boosting frameworks in our modeling approach which are Extreme Gradient Boosting (XGBoost) and Light Gradient Boosting Machine (LightGBM). Both algorithms working by growing boosted decision trees. However, there is slight difference in the growing method. While XGBoost applies level-wise tree growth LightGBM applies leaf-wise tree growth. Level-wise approach meaning it grows horizontal whereas leaf-wise grows vertical. Moreover, leaf-wise approach is mostly faster than the level-wise approach making LightGBM appealing. However, leaf-wise more likely to overfit on the data, therefore we can say XGBoost has the advantage of building more robust models.</p>
<h3 id="ligth-gradient-boosting-machine-lightgbm">Ligth Gradient Boosting Machine (LightGBM)<a class="headerlink" href="#ligth-gradient-boosting-machine-lightgbm" title="Permanent link">&para;</a></h3>
<p>For the LightGBM parameters <code>number of estimators</code> (n_estimators), <code>maximum tree depth</code> (max_depth) and <code>learning rate</code> (learning_rate) is tuned prior to the benchmark in a 3-fold cross validation. Also, <code>feature selector</code> that removes low-variance features is tuned with different thresholds of 0, 0.01 and 0.001. Moreover, all the features are scaled to a standard scale using <code>standard-scaler</code>.</p>
<p>By using the data twice, once for hyperparameter tuning and once for the benchmark, we might underestimate the generalization error. However since hyperparameter tuning is computationally expensive, and we are not interested in the precise generalization error of each model but rather the general tendency of each model's performance, we refrained from nested resampling.</p>
<p>After the tuning, following parameter set resulted with the best mean test set score:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Lower Bound</th>
<th>Upper Bound</th>
<th>RMSE Optimal Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>variance_threshold</td>
<td>0.001</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>learning_rate</td>
<td>0.01</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr>
<td>max_depth</td>
<td>-1</td>
<td>20</td>
<td>-1</td>
</tr>
<tr>
<td>n_estimators</td>
<td>50</td>
<td>500</td>
<td>500</td>
</tr>
</tbody>
</table>
<p>Our best model's test set score averaged at ~0.88 for the LightGBM. For further analysis, mean test score versus parameters plot can be seen below.</br></br></p>
<figure>
  <img src="../assets/lightgbm_tuning.png" width="800" />
  <figcaption>LightGBM Parameters vs. Mean Test Score</figcaption>
</figure>

<h3 id="extreme-gradient-boosting-xgboost">Extreme Gradient Boosting (XGBoost)<a class="headerlink" href="#extreme-gradient-boosting-xgboost" title="Permanent link">&para;</a></h3>
<p>For the XGBoost parameters <code>number of estimators</code> (n_estimators), <code>maximum tree depth</code> (max_depth) and <code>learning rate</code> (eta) is tuned prior to the benchmark in a 3-fold cross validation. Here, <code>standard-scaler</code> used but feature selector hasn't applied since it showed no difference in the previous analysis.</p>
<p>After the tuning, following parameter set resulted with the best mean test set score:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Lower Bound</th>
<th>Upper Bound</th>
<th>RMSE Optimal Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>learning_rate</td>
<td>0.05</td>
<td>0.2</td>
<td>0.05</td>
</tr>
<tr>
<td>max_depth</td>
<td>3</td>
<td>12</td>
<td>3</td>
</tr>
<tr>
<td>n_estimators</td>
<td>100</td>
<td>500</td>
<td>300</td>
</tr>
</tbody>
</table>
<p>Our best model's test set score averaged at ~0.95 for the XGBoost. For further analysis, mean test score versus parameters plot can be seen below.</br></br></p>
<figure>
  <img src="../assets/xgb_tuning.png" width="800" />
  <figcaption>XGBoost Parameters vs. Mean Test Score</figcaption>
</figure>

<h3 id="support-vector-machines-svm">Support Vector Machines (SVM)<a class="headerlink" href="#support-vector-machines-svm" title="Permanent link">&para;</a></h3>
<p>Support vector machines (SVM) try to find a separating hyperplane between the target categories. In this analysis, a radial kernel is recommended and the hyperparameters cost and gamma should be tuned in cross-validation prior to the benchmark. It would be nice to have a kernel base model trained on the dataset however it requires much more power and time to train SVMs. Therefore, we will stick to the tree-based methods which seems to have good performance on our dataset.</p>
<h2 id="model-evaluation">Model Evaluation<a class="headerlink" href="#model-evaluation" title="Permanent link">&para;</a></h2>
<p>Since we now know the best parameters for our models. Models trained on training set with those parameters then metrics are calculated over the whole dataset. Error metrics for the both models are tabulated below:</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>MSE</th>
<th>RMSE</th>
<th>R2</th>
<th>MAE</th>
<th>MAD</th>
</tr>
</thead>
<tbody>
<tr>
<td>XGBoost</td>
<td>55.547</td>
<td>7.453</td>
<td>0.997</td>
<td>0.420</td>
<td>0.192</td>
</tr>
<tr>
<td>LightGBM</td>
<td>1271.374</td>
<td>35.656</td>
<td>0.924</td>
<td>0.842</td>
<td>0.061</td>
</tr>
</tbody>
</table>
<p>By looking at the metrics above, we can say that the XGBoost outperformed the LightGBM regressor. However, we should analyze the residuals to be sure about our decision. First we would like to check whether the residuals are centered around zero or not. To do that 95% confidence interval is constructed around the residual means. For XGBoost 95% CI corresponds to <code>(-0.010, 0.038)</code> and for LightGBM it is <code>(-0.202, 0.026)</code>. For both predictors' confidence intervals covers zero then we can say that our predictions are unbiased.</p>
<p>Next we will be looking at the scatter plot of the residuals of the model. From the figure below, you can see the residual distribution of the predictions which fall into 99.9th percentile.</br></br></p>
<figure>
  <img src="../assets/scatter_residuals.png" width="800" />
  <figcaption>Scatter plot of the residuals within 99.9th percentile</figcaption>
</figure>

<p>From the above plot, residual distributions seem to be randomly distributed with mean close to zero.</p>
<p>Reverse cumulative distribution of the residuals is show below in order to further asses our predictor performances. Reverse cumulative distribution of the residuals of the models are proof for the model performances. As you can see from the plot, ~90% of the residuals are fall into the range between 0 and 1 indicating little to no errors. We see steeper decrease of reverse cumulative function for the LightGBM however XGBoost covers it up in the higher residual values. Therefore, LightGBM might be a better fit for more than 80% of the data while XGBoost is more robust over the dataset.</br></br></p>
<figure>
  <img src="../assets/reverse_residuals.png" width="800" />
  <figcaption>Reverse cumulative distribution of the residuals</figcaption>
</figure>

<p>Lastly, we want to compare predictions and actual scores for XGBoost model in the plot below. Here, we don't see many points far from the diagonal which is a good sign. Green points represents the errors with less than 5% mean absolute percentage and we see a lot of green points when we zoomed into the bottom-left corner of the plot. </br></br></p>
<figure>
  <img src="../assets/predictions_scatter.png" width="800" />
  <figcaption>Comparison between predictions and actual scores for XGBoost</figcaption>
</figure>

<figure>
  <img src="../assets/predictions_scatter_zoom.png" width="800" />
  <figcaption>Comparison between predictions and actual scores for XGBoost bottom-left zoomed</figcaption>
</figure>

<h3 id="feature-importances">Feature Importances<a class="headerlink" href="#feature-importances" title="Permanent link">&para;</a></h3>
<h4 id="permutation-feature-importance">Permutation Feature Importance<a class="headerlink" href="#permutation-feature-importance" title="Permanent link">&para;</a></h4>
<p>Permutation feature importance is, as the name suggests, a method to quantify the importance of a feature. It is measured by calculating the increase in the model’s prediction error after permuting the feature of interest. Intuitively, permuting or shuffling all values of a feature destroys any relationship between the given feature and the target. If the error increases by breaking the relationship, the given feature must have been important for model prediction. </p>
<p>It is important to analyze which features are models mostly depending on. Therefore, feature importance plots for XGBoost and LightGBm are shown below:</br></br></p>
<figure>
  <img src="../assets/xgb_feature_imp.png" width="800" />
  <figcaption>Feature impotances for XGBoost</figcaption>
</figure>

<figure>
  <img src="../assets/lgbm_feature_imp.png" width="800" />
  <figcaption>Feature importances for LightGBM</figcaption>
</figure>

<p>When we look at the feature importance plots, we can see that top 4 important features and their order are the same for both models. Those features are <code>outfit_liked</code>, <code>item_added</code>, <code>comment_posted</code> and <code>comment_liked</code> with significant contribution compare to the other features. </p>
<h4 id="shapley-feature-importance">Shapley Feature Importance<a class="headerlink" href="#shapley-feature-importance" title="Permanent link">&para;</a></h4>
<p>Shapley values help us to measure each feature’s contribution to the prediction of an instance, more precisely they measure how much a feature contributed to the prediction compared to the average prediction. They are calculated by averaging the marginal payout or contribution for each feature. Assuming we are interested in the contribution of feature x. First, the prediction for every combination of features not including x is calculated. Then we measure the marginal contribution of x, i.e. how adding x to each combination changes the prediction. Finally, all marginal contributions are averaged and we obtain the Shapley value for feature x. Since there are many possible coalitions of the feature values, calculating Shapley values is computationally expensive.</p>
<p>We want to asses whether the feature importance is also consistent when using a Shapley based measure instead of permutation feature importance. For each feature, the Shapley feature importance is the mean absolute value of the Shapley values of all observations. This means that features which have high (absolute) Shapley values for many emails have a high importance in general. Shapley values of XGBoost model can be found in the figure below. By looking at the mean shapley values of the features, we can say that permutation and shapley plots are consistent with each other on the top 4 features.</br></br></p>
<figure>
  <img src="../assets/shap_xgb.png" width="800" />
  <figcaption>Shapley feature impotances for XGBoost</figcaption>
</figure>

<h2 id="statistical-models">Statistical Models<a class="headerlink" href="#statistical-models" title="Permanent link">&para;</a></h2>
<p>Machine learning techniques provided good results on the retention score prediction. Now, we would like to see how statistical models are performing on the user data. For that purpose we will use generalized linear models (GLMs). The GLM regression finds the most likely value of variable coefficients (ß) for the given data. In most cases this requires an iterative algorithm that maximises the log-likelihood function.</p>
<p>In our case, since our data is right-skewed it needs prior transformation to fit the regression models on otherwise model assumptions will be violated. Response functions that could be useful to model right-skewed outcome are poisson and negative binomial. However, those family functions require discrete response variable. In our case, the target variable that we have is continuous, positive and right-skewed. Therfore, we will use Gaussian and Gamma families and apply log-transformation on the dataset.</p>
<p>As our initial predictors, we will use the top 4 features from our machine learning models which are <code>outfit_liked</code>, <code>item_added</code>, <code>comment_posted</code> and <code>comment_liked</code>. Also, we will not include any interaction terms for now.</br></br></p>
<figure>
  <img src="../assets/stat_gauss_fit.png" width="800" />
  <figcaption>Gaussian model fit</figcaption>
</figure>

<p>Above plot shows the fit for retention score by the gaussian model. As we go towards higher retention scores in the plot, the prediction errors seem to go larger. Therefore, residuals versus predictions are visualized below. From there, gaussian model overpredicts in the higher range of retention scores since we see larger negative errors.</br></br></p>
<figure>
  <img src="../assets/stat_gauss_residuals.png" width="800" />
  <figcaption>Gaussian model residuals</figcaption>
</figure>

<p>To eliminate the tendency of overprediction, interaction terms are decided to be added to the model. Resulting model fit is visualized below.</br></br></p>
<figure>
  <img src="../assets/stat_gauss2_fit.png" width="800" />
  <figcaption>Gaussian model with interactions fit</figcaption>
</figure>

<p>The model with interactions has much smaller deviance and pearson score indicating better fit to our data.</p>
<p>Then, gamma model applied but it wasn't a good fit to the data.</p>
<p>We stopped our anaylsis at this point. However, models with different link functions or penalties might be introduced to find a better fitting model. Also, different approcahes like ridge or lasso regression can be implemented with different link functions.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../data/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Dataset" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Dataset
            </div>
          </div>
        </a>
      
      
        
        <a href="../extra/" class="md-footer__link md-footer__link--next" aria-label="Next: Extras" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Extras
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            2021 - Utku Can Ozturk
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/utkucanozturk/" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://linkedin.com/in/utkucanozturk/" target="_blank" rel="noopener" title="linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.tabs.link", "navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top", "navigation.sections", "search.highlight", "search.share", "search.suggest"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>